# Generated by automation script
from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass

from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass
from paddleocr import TableStructureRecognition

class PyTorch_PaddleOCR_SLANeXt_Wired_Table_Structure_Recognition(PyTorchAbstractClass):
    def __init__(self, config=None):
        self.config = config if config else dict()
        device = self.config.pop("_device", "cpu")
        # paddleocr uses 'gpu' instead of 'cuda'
        if device.startswith("cuda"):
            device = "gpu"

        # The model card shows initialization like this.
        # The 'model_name' is hardcoded as it's specific to this wrapper.
        self.model = TableStructureRecognition(model_name="SLANeXt_wired", device=device)

        self.batch_size = self.config.get('batch_size', 1)

    def preprocess(self, input_images):
        # The paddleocr predict method directly accepts image paths.
        return input_images

    def predict(self, model_input):
        # The model's predict method takes a list of image paths.
        return self.model.predict(input=model_input, batch_size=self.batch_size)

    def postprocess(self, model_output):
        # The model output is a list of dictionaries, each containing the recognized structure.
        # We extract the 'structure' list and join it to form a single HTML string for each image.
        captions = []
        for res in model_output:
            if res and 'res' in res and 'structure' in res['res']:
                html_structure = ''.join(res['res']['structure'])
                captions.append(html_structure.strip())
            else:
                captions.append("") # Append empty string if structure is not found
        return captions
