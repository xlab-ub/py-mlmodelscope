# Generated by automation script
from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass

from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass
from transformers import AutoProcessor, Qwen3VLMoeForConditionalGeneration
from PIL import Image
import re
import torch

class PyTorch_Transformers_Gelato_30B_A3B(PyTorchAbstractClass):
    def __init__(selfconfig):
        super().__init__(config)
        self.instruction = config.get("instruction", "Reload the cache.")
        self.processor = AutoProcessor.from_pretrained('mlfoundations/Gelato-30B-A3B')
        self.load_hf_model(Qwen3VLMoeForConditionalGeneration, 'mlfoundations/Gelato-30B-A3B')

    def preprocess(self, input_images):
        PROMPT = "You are an expert UI element locator. Given a GUI image and a user's element description, provide the coordinates of the specified element as a single (x,y) point. For elements with area, return the center point. Output the coordinate pair exactly: (x,y)".strip()
        img = Image.open(input_images[0]).convert("RGB")
        messages = [
            {
                "role": "user",
                "content": [
                    {"type": "text", "text": PROMPT + "\n\n"},
                    {"type": "image", "image": img},
                    {"type": "text", "text": "\n" + self.instruction},
                ],
            }
        ]
        device = next(self.model.parameters()).device
        model_input = self.processor.apply_chat_template(
            messages,
            tokenize=True,
            add_generation_prompt=True,
            return_dict=True,
            return_tensors="pt"
        ).to(device)
        self.original_input_ids = model_input.input_ids
        return model_input

    def predict(self, model_input):
        return self.model.generate(**model_input, max_new_tokens=32)

    def postprocess(self, model_output):
        generated_ids_trimmed = [out_ids[len(in_ids):] for in_ids, out_ids in zip(self.original_input_ids, model_output)]
        output_text = self.processor.batch_decode(generated_ids_trimmed, skip_special_tokens=True, clean_up_tokenization_spaces=False)
        raw_string = output_text[0]
        try:
            matches = re.findall(r'\((\d+),\s*(\d+)\)', raw_string)
            if matches:
                x, y = map(int, matches[0])
                scores = [1.0]
                labels = [1]
                boxes = [[float(x), float(y), float(x), float(y)]]
            else:
                scores, labels, boxes = [], [], []
        except:
            scores, labels, boxes = [], [], []
        return [scores], [labels], [boxes]
