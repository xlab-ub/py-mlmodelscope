# Generated by automation script
from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass

from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass
from ultralyticsplus import YOLO
from PIL import Image
import warnings

class PyTorch_Ultralytics_YOLOv8m_BloodCellDetection(PyTorchAbstractClass):
    def __init__(self, config=None):
        self.config = config if config else dict()
        self.device = self.config.pop("_device", "cpu")
        multi_gpu = self.config.pop("_multi_gpu", False) # ultralytics handles multi-gpu internally

        warnings.warn("The batch size should be 1.")

        model_id = 'keremberke/yolov8m-blood-cell-detection'
        self.model = YOLO(model_id)

        # Set model parameters from config or use defaults from Hugging Face page
        self.model.overrides['conf'] = self.config.get('conf', 0.25)
        self.model.overrides['iou'] = self.config.get('iou', 0.45)
        self.model.overrides['agnostic_nms'] = self.config.get('agnostic_nms', False)
        self.model.overrides['max_det'] = self.config.get('max_det', 1000)

    def preprocess(self, input_images):
        # Ultralytics YOLO model handles preprocessing internally.
        # The input is expected to be a list of image paths.
        return input_images

    def predict(self, model_input):
        # The model.predict method takes the image paths and performs inference.
        return self.model.predict(model_input, device=self.device)

    def postprocess(self, model_output):
        # model_output is a list of ultralytics Results objects.
        # Assuming batch size is 1 as per the warning in __init__.
        results = model_output[0]

        scores = results.boxes.conf.tolist()
        labels = results.boxes.cls.tolist()
        boxes = results.boxes.xyxy.tolist()

        return [scores], [labels], [boxes]
