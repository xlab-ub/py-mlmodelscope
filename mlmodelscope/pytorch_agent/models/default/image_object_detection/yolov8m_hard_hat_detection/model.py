# Generated by automation script
from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass

from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass
from ultralyticsplus import YOLO
from PIL import Image

class PyTorch_UltralyticsPlus_YOLOv8m_HardHat(PyTorchAbstractClass):
    def __init__(self, config=None):
        self.config = config if config else dict()
        self.device = self.config.pop("_device", "cpu")
        multi_gpu = self.config.pop("_multi_gpu", False) # Note: multi_gpu is not directly used by ultralyticsplus YOLO class in this way

        model_id = 'keremberke/yolov8m-hard-hat-detection'
        self.model = YOLO(model_id)

        # Set model parameters from the example, allowing overrides from config
        self.model.overrides['conf'] = self.config.get('conf', 0.25)
        self.model.overrides['iou'] = self.config.get('iou', 0.45)
        self.model.overrides['agnostic_nms'] = self.config.get('agnostic_nms', False)
        self.model.overrides['max_det'] = self.config.get('max_det', 1000)

    def preprocess(self, input_images):
        # The ultralytics YOLO model can directly take image paths for prediction
        # Preprocessing is handled internally by the library
        model_input = input_images
        return model_input

    def predict(self, model_input):
        # The predict method handles inference and can be passed the device
        return self.model.predict(model_input, device=self.device)

    def postprocess(self, model_output):
        all_scores = []
        all_labels = []
        all_boxes = []
        # model_output is a list of Results objects, one for each input image
        for result in model_output:
            scores = result.boxes.conf.tolist()
            labels = result.boxes.cls.tolist()
            boxes = result.boxes.xyxy.tolist() # Using absolute coordinates (xyxy)
            all_scores.append(scores)
            all_labels.append(labels)
            all_boxes.append(boxes)
        return all_scores, all_labels, all_boxes
