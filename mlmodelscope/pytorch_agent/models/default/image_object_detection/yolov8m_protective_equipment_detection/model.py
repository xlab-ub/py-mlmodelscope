# Generated by automation script
from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass

from mlmodelscope.pytorch_agent.models.pytorch_abc import PyTorchAbstractClass
from ultralyticsplus import YOLO
from PIL import Image
import torch

class PyTorch_Ultralytics_YOLOv8m(PyTorchAbstractClass):
    def __init__(self, config=None):
        self.config = config if config else dict()
        self.device = self.config.pop("_device", "cpu")
        multi_gpu = self.config.pop("_multi_gpu", False) # ultralytics handles multi-gpu internally

        self.model = YOLO('keremberke/yolov8m-protective-equipment-detection')

        # Set model parameters from config or use defaults from Hugging Face page
        self.model.overrides['conf'] = self.config.get('conf', 0.25)
        self.model.overrides['iou'] = self.config.get('iou', 0.45)
        self.model.overrides['agnostic_nms'] = self.config.get('agnostic_nms', False)
        self.model.overrides['max_det'] = self.config.get('max_det', 1000)

    def preprocess(self, input_images):
        # The ultralytics model can directly take image paths
        return input_images

    def predict(self, model_input):
        # The model.predict method takes a list of image paths and returns a list of Results objects
        return self.model.predict(model_input, device=self.device)

    def postprocess(self, model_output):
        # The output is a list of Results objects, one for each image.
        # We process the first (and likely only) result for a batch size of 1.
        results = model_output[0]
        
        # boxes.data contains [x1, y1, x2, y2, conf, cls]
        boxes_data = results.boxes.data
        
        # Ensure tensor is on CPU for .tolist() conversion
        if boxes_data.is_cuda:
            boxes_data = boxes_data.cpu()
            
        scores = boxes_data[:, 4].tolist()
        labels = boxes_data[:, 5].int().tolist()
        boxes = boxes_data[:, :4].tolist()
        
        # The expected output is a list for each component, for each image in the batch
        return [scores], [labels], [boxes]
